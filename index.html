<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å°å‰ç™¼å¤§è²¡ V14</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', green: '#34C759', red: '#FF3B30', purple: '#5856D6', orange: '#FF9500' },
                        morandi: { main: '#778DA9', pink: '#F4ACB7', light: '#E0E1DD', accent: '#415A77', gold: '#D4AF37' }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Noto Sans TC"', 'sans-serif'],
                        rounded: ['"Zen Maru Gothic"', 'sans-serif'],
                    },
                    boxShadow: { 'ios': '0 2px 10px rgba(0,0,0,0.05)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F2F2F7; -webkit-tap-highlight-color: transparent; padding-bottom: env(safe-area-inset-bottom); }
        .ios-card { background: white; border-radius: 12px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .ios-header { padding: 12px 16px; border-bottom: 1px solid #F2F2F7; }
        .ios-header-title { font-size: 13px; font-weight: 700; color: #8E8E93; text-transform: uppercase; letter-spacing: 0.5px; }
        .input-label { font-size: 12px; color: #8E8E93; font-weight: 600; margin-left: 4px; margin-bottom: 4px; }
        .input-field { background: #F2F2F7; border-radius: 8px; padding: 12px; font-size: 16px; outline: none; width: 100%; border: 1px solid transparent; transition: all 0.2s; appearance: none; }
        .input-field:focus { background: white; border-color: #E5E5EA; box-shadow: 0 0 0 2px rgba(0,122,255,0.1); }
        
        .tag-btn { padding: 8px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; transition: all 0.2s; border: 1px solid transparent; display: flex; align-items: center; gap: 4px; }
        .tag-btn-active { background-color: #778DA9; color: white; border-color: #778DA9; }
        .tag-btn-inactive { background-color: #F2F2F7; color: #64748B; border-color: #E5E5EA; }

        .segment-control { background-color: #E5E5EA; padding: 2px; border-radius: 9px; display: flex; margin-bottom: 16px; }
        .segment-btn { flex: 1; padding: 6px; text-align: center; border-radius: 7px; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .active-tab { background-color: white; color: black; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .inactive-tab { color: #636366; }
        
        @keyframes fillBar { from { width: 0%; } }
        .progress-fill { animation: fillBar 1s ease-out forwards; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 100%; max-width: 320px; border-radius: 16px; padding: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popUp 0.2s ease-out; }
        @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="pb-24">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const getLocalISODate = () => {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return new Date(now - offset).toISOString().slice(0, 10);
        };
        const fmt = (num) => new Intl.NumberFormat('zh-TW').format(num);
        const useLocalStorage = (key, initialValue) => {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            });
            const setValue = (value) => {
                const valueToStore = value instanceof Function ? value(storedValue) : value;
                setStoredValue(valueToStore);
                window.localStorage.setItem(key, JSON.stringify(valueToStore));
            };
            return [storedValue, setValue];
        };

        const INITIAL_CATEGORIES = [
            { id: 'rent', label: 'æˆ¿ç§Ÿ', amount: 9974, icon: 'fa-house' },
            { id: 'mgmt', label: 'ç®¡ç†è²»', amount: 1410, icon: 'fa-building' },
            { id: 'car', label: 'è»Šè²¸', amount: 20000, icon: 'fa-car' },
            { id: 'scooter', label: 'æ©Ÿè»Šè²¸', amount: 7000, icon: 'fa-motorcycle' },
            { id: 'baby', label: '77å¯¶è²', amount: 30000, icon: 'fa-heart' },
            { id: 'credit', label: 'ä¿¡ç”¨å¡', amount: 0, icon: 'fa-credit-card' },
            { id: 'other', label: 'å…¶ä»–', amount: '', icon: 'fa-basket-shopping' }
        ];

        // --- å…¨ç”¨åˆªé™¤ç¢ºèª Modal ---
        const ConfirmDeleteModal = ({ isOpen, onClose, onConfirm, title = "ç¢ºå®šåˆªé™¤å—ï¼Ÿ" }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="text-center mb-6">
                            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 text-red-500 text-xl">
                                <i className="fa-solid fa-trash-can"></i>
                            </div>
                            <h3 className="text-lg font-bold text-gray-800">{title}</h3>
                            <p className="text-xs text-gray-400 mt-1">åˆªé™¤å¾Œç„¡æ³•å¾©åŸ</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl text-sm active:bg-gray-200">
                                å–æ¶ˆ
                            </button>
                            <button onClick={onConfirm} className="flex-1 bg-red-500 text-white font-bold py-3 rounded-xl text-sm shadow-md active:bg-red-600">
                                ç¢ºèªåˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- åˆ†é¡ç®¡ç† Modal ---
        const CategoryManagerModal = ({ isOpen, onClose, categories, setCategories }) => {
            const [newLabel, setNewLabel] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [deleteTarget, setDeleteTarget] = useState(null); // æš«å­˜è¦åˆªé™¤çš„ID

            if (!isOpen) return null;

            const handleAdd = () => {
                if (!newLabel) return;
                const newCat = {
                    id: Date.now().toString(),
                    label: newLabel,
                    amount: newAmount,
                    icon: 'fa-tag'
                };
                setCategories([...categories, newCat]);
                setNewLabel('');
                setNewAmount('');
            };

            const confirmDeleteCategory = () => {
                if(deleteTarget) {
                    setCategories(categories.filter(c => c.id !== deleteTarget));
                    setDeleteTarget(null);
                }
            };

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {/* é€™è£¡æˆ‘å€‘åµŒå¥—ä¸€å€‹ç°¡å–®çš„ç¢ºèªé‚è¼¯ï¼Œé¿å…è¦–çª—ç–Šè¦–çª—å¤ªè¤‡é›œ */}
                        {deleteTarget ? (
                            <div className="text-center py-4">
                                <h3 className="font-bold text-red-500 mb-4">ç¢ºå®šåˆªé™¤æ­¤åˆ†é¡ï¼Ÿ</h3>
                                <div className="flex gap-2">
                                    <button onClick={() => setDeleteTarget(null)} className="flex-1 bg-gray-200 py-2 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                                    <button onClick={confirmDeleteCategory} className="flex-1 bg-red-500 text-white py-2 rounded-lg text-sm font-bold">åˆªé™¤</button>
                                </div>
                            </div>
                        ) : (
                            <>
                                <h3 className="text-lg font-bold text-gray-800 mb-4">ç®¡ç†æ”¯å‡ºåˆ†é¡</h3>
                                <div className="mb-4 space-y-2">
                                    {categories.map(cat => (
                                        <div key={cat.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                                            <div className="flex items-center gap-2">
                                                <i className={`fa-solid ${cat.icon} text-gray-400 w-5 text-center`}></i>
                                                <span className="font-bold text-gray-700">{cat.label}</span>
                                                {cat.amount && <span className="text-xs text-gray-400">(${cat.amount})</span>}
                                            </div>
                                            {cat.id !== 'other' && (
                                                <button onClick={() => setDeleteTarget(cat.id)} className="w-8 h-8 flex items-center justify-center text-red-400 hover:text-red-600 bg-white rounded-full shadow-sm">
                                                    <i className="fa-solid fa-trash-can"></i>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <div className="border-t border-gray-100 pt-4">
                                    <h4 className="text-xs font-bold text-gray-400 uppercase mb-2">æ–°å¢åˆ†é¡</h4>
                                    <div className="flex gap-2 mb-2">
                                        <input type="text" className="input-field text-sm" placeholder="åç¨±" value={newLabel} onChange={e => setNewLabel(e.target.value)} />
                                        <input type="number" inputMode="decimal" className="input-field text-sm w-24" placeholder="é è¨­$" value={newAmount} onChange={e => setNewAmount(e.target.value)} />
                                    </div>
                                    <button onClick={handleAdd} className="w-full bg-morandi-main text-white rounded-lg py-2 font-bold text-sm shadow-sm">+ æ–°å¢</button>
                                </div>
                                <button onClick={onClose} className="w-full mt-4 text-gray-400 text-sm py-2">é—œé–‰</button>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // --- Forms ---
        const ExpenseForm = ({ onAdd, categories, setCategories }) => {
            const [selectedId, setSelectedId] = useState('other');
            const [vals, setVals] = useState({ date: getLocalISODate(), name: '', amount: '' });
            const [isManageOpen, setIsManageOpen] = useState(false);

            useEffect(() => {
                if (selectedId !== 'other' && !categories.find(c => c.id === selectedId)) {
                    setSelectedId('other');
                }
            }, [categories, selectedId]);

            const handleTypeSelect = (cat) => {
                setSelectedId(cat.id);
                setVals(prev => ({ ...prev, name: cat.id === 'other' ? '' : cat.label, amount: cat.amount }));
            };

            const handleSubmit = () => {
                if (!vals.name || !vals.amount) return;
                onAdd({ ...vals, category: selectedId });
                setVals({ date: vals.date, name: '', amount: '' });
                setSelectedId('other');
            };

            return (
                <div className="ios-card">
                    <div className="ios-header flex justify-between items-center">
                        <span className="ios-header-title">æ–°å¢æ”¯å‡ºç´€éŒ„</span>
                        <button onClick={() => setIsManageOpen(true)} className="text-xs text-ios-blue font-bold flex items-center gap-1 bg-blue-50 px-2 py-1 rounded-lg">
                            <i className="fa-solid fa-gear"></i> è¨­å®š
                        </button>
                    </div>
                    <div className="p-4 space-y-4">
                        <div className="flex flex-wrap gap-2">
                            {categories.map((cat) => (
                                <button key={cat.id} onClick={() => handleTypeSelect(cat)} className={`tag-btn ${selectedId === cat.id ? 'tag-btn-active' : 'tag-btn-inactive'}`}>
                                    <i className={`fa-solid ${cat.icon}`}></i> {cat.label}
                                </button>
                            ))}
                        </div>
                        <div><div className="input-label">æ—¥æœŸ</div><input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="input-field" /></div>
                        <div className="flex gap-3">
                            <div className="flex-[1.5]"><div className="input-label">é …ç›®åç¨±</div><input type="text" value={vals.name} onChange={e => setVals({...vals, name: e.target.value})} className="input-field" placeholder="é …ç›®" /></div>
                            <div className="flex-1"><div className="input-label">é‡‘é¡</div><input type="number" inputMode="decimal" value={vals.amount} onChange={e => setVals({...vals, amount: e.target.value})} className="input-field font-bold text-red-500" placeholder="$" /></div>
                        </div>
                        <button onClick={handleSubmit} className="w-full py-3.5 rounded-lg text-white font-bold text-sm bg-morandi-main shadow-sm active:opacity-90"><i className="fa-solid fa-plus mr-1"></i> åŠ å…¥æ”¯å‡º</button>
                    </div>
                    <CategoryManagerModal isOpen={isManageOpen} onClose={() => setIsManageOpen(false)} categories={categories} setCategories={setCategories} />
                </div>
            );
        };

        const WorkHoursForm = ({ onAdd }) => {
            const [vals, setVals] = useState({ date: getLocalISODate(), note: '', days: '', amount: '' });
            const handleDaysChange = (val) => {
                const days = val;
                setVals(prev => ({ ...prev, days: days, amount: days ? days * 3000 : '' }));
            };
            const handleSubmit = () => {
                if (!vals.days) return;
                onAdd(vals);
                setVals({ date: vals.date, note: '', days: '', amount: '' });
            };
            return (
                <div className="ios-card">
                    <div className="ios-header"><span className="ios-header-title">æ–°å¢å·¥æ™‚ (æˆ‘åšçš„)</span></div>
                    <div className="p-4 space-y-4">
                        <div className="flex gap-3">
                            <div className="flex-1"><div className="input-label">æ—¥æœŸ</div><input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="input-field" /></div>
                            <div className="flex-1"><div className="input-label">å·¥åœ°/å‚™è¨»</div><input type="text" value={vals.note} onChange={e => setVals({...vals, note: e.target.value})} className="input-field" placeholder="å‚™è¨»" /></div>
                        </div>
                        <div className="flex gap-3">
                            <div className="flex-1"><div className="input-label">åšå¹¾å·¥ ($3000/å·¥)</div><input type="number" inputMode="decimal" value={vals.days} onChange={e => handleDaysChange(e.target.value)} className="input-field text-center font-bold text-purple-600" placeholder="0.5 / 1" step="0.5" /></div>
                            <div className="flex-1"><div className="input-label">é è¨ˆæ”¶å…¥</div><input type="number" inputMode="decimal" value={vals.amount} readOnly className="input-field font-bold bg-gray-50 text-gray-500" /></div>
                        </div>
                        <button onClick={handleSubmit} className="w-full py-3.5 rounded-lg text-white font-bold text-sm bg-ios-purple shadow-sm active:opacity-90"><i className="fa-solid fa-person-digging mr-1"></i> ç´€éŒ„åšå·¥</button>
                    </div>
                </div>
            );
        };

        const WorkWithdrawForm = ({ onAdd }) => {
            const [vals, setVals] = useState({ date: getLocalISODate(), note: '', days: '', amount: '' });
            const handleDaysChange = (val) => {
                const days = val;
                setVals(prev => ({ ...prev, days: days, amount: days ? days * 3000 : '' }));
            };
            const handleSubmit = () => {
                if (!vals.amount) return;
                onAdd(vals);
                setVals({ date: vals.date, note: '', days: '', amount: '' });
            };
            return (
                <div className="ios-card border-l-4 border-ios-green">
                    <div className="ios-header"><span className="ios-header-title text-ios-green">ç´€éŒ„å·²é ˜ (æˆ‘é ˜çš„)</span></div>
                    <div className="p-4 space-y-4">
                        <div className="flex gap-3">
                            <div className="flex-1"><div className="input-label">æ—¥æœŸ</div><input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="input-field" /></div>
                            <div className="flex-1"><div className="input-label">å‚™è¨»</div><input type="text" value={vals.note} onChange={e => setVals({...vals, note: e.target.value})} className="input-field" placeholder="å¦‚: 7/5é ˜éŒ¢" /></div>
                        </div>
                        <div className="flex gap-3">
                            <div className="flex-1"><div className="input-label">é ˜å¹¾å·¥</div><input type="number" inputMode="decimal" value={vals.days} onChange={e => handleDaysChange(e.target.value)} className="input-field text-center font-bold text-green-600" placeholder="å·¥æ•¸" /></div>
                            <div className="flex-1"><div className="input-label">å¯¦éš›é‡‘é¡</div><input type="number" inputMode="decimal" value={vals.amount} onChange={e => setVals({...vals, amount: e.target.value})} className="input-field font-bold text-black" /></div>
                        </div>
                        <button onClick={handleSubmit} className="w-full py-3.5 rounded-lg text-white font-bold text-sm bg-ios-green shadow-sm active:opacity-90"><i className="fa-solid fa-money-bill-wave mr-1"></i> ç´€éŒ„å·²é ˜</button>
                    </div>
                </div>
            );
        };

        const ProjectExpenseForm = ({ onAdd }) => {
            const [vals, setVals] = useState({ date: getLocalISODate(), note: '', amount: '' });
            const handleSubmit = () => {
                if (!vals.amount) return;
                onAdd(vals);
                setVals({ date: vals.date, note: '', amount: '' });
            };
            return (
                <div className="ios-card border-l-4 border-ios-orange">
                    <div className="ios-header"><span className="ios-header-title text-ios-orange">å·¥åœ°æ”¯å‡º (é›œæ”¯/ææ–™)</span></div>
                    <div className="p-4 space-y-4">
                        <div className="flex gap-3">
                            <div className="flex-1"><div className="input-label">æ—¥æœŸ</div><input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="input-field" /></div>
                            <div className="flex-[1.5]"><div className="input-label">é …ç›® (ä¾¿ç•¶ã€é£²æ–™...)</div><input type="text" value={vals.note} onChange={e => setVals({...vals, note: e.target.value})} className="input-field" placeholder="é …ç›®" /></div>
                        </div>
                        <div className="flex gap-3">
                            <div className="flex-[2]"><div className="input-label">é‡‘é¡</div><input type="number" inputMode="decimal" value={vals.amount} onChange={e => setVals({...vals, amount: e.target.value})} className="input-field font-bold text-orange-600" placeholder="$" /></div>
                            <button onClick={handleSubmit} className="flex-1 rounded-lg text-white font-bold text-sm bg-ios-orange shadow-sm active:opacity-90"><i className="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const SimpleInput = ({ title, onAdd, btnColor, inputColor = "text-black" }) => {
            const [vals, setVals] = useState({ date: getLocalISODate(), note: '', amount: '' });
            const handleSubmit = () => {
                if (!vals.amount) return;
                onAdd(vals);
                setVals({ date: vals.date, note: '', amount: '' });
            };
            return (
                <div className="ios-card">
                    <div className="ios-header"><span className="ios-header-title">{title}</span></div>
                    <div className="p-4 flex flex-col gap-3">
                        <div className="flex gap-2">
                            <input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="input-field flex-1" />
                            <input type="text" value={vals.note} onChange={e => setVals({...vals, note: e.target.value})} className="input-field flex-[1.5]" placeholder="å‚™è¨»" />
                        </div>
                        <div className="flex gap-2">
                            <input type="number" inputMode="decimal" value={vals.amount} onChange={e => setVals({...vals, amount: e.target.value})} className={`input-field flex-[2] font-bold ${inputColor}`} placeholder="$ é‡‘é¡" />
                            <button onClick={handleSubmit} className={`flex-1 rounded-lg text-white font-bold text-sm ${btnColor}`}><i className="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ProjectPaymentForm = ({ title, onAdd }) => {
             const [vals, setVals] = useState({ date: getLocalISODate(), name: '', days: '', amount: '' });
             const handleDaysChange = (val) => {
                 const days = val;
                 setVals(prev => ({ ...prev, days: days, amount: days ? days * 3000 : '' }));
             };
             const handleSubmit = () => {
                 if(!vals.name || !vals.amount) return;
                 onAdd(vals);
                 setVals({ date: vals.date, name: '', days: '', amount: '' });
             };
             return (
                 <div className="ios-card">
                     <div className="ios-header"><span className="ios-header-title">{title}</span></div>
                     <div className="p-4 space-y-3">
                         <div className="flex gap-2">
                             <input type="date" value={vals.date} onChange={e => setVals({...vals, date: e.target.value})} className="input-field flex-1" />
                             <input type="text" value={vals.name} onChange={e => setVals({...vals, name: e.target.value})} className="input-field flex-1" placeholder="é ˜æ¬¾äºº" />
                         </div>
                         <div className="flex gap-2">
                             <div className="flex-1 relative">
                                 <input type="number" inputMode="decimal" value={vals.days} onChange={e => handleDaysChange(e.target.value)} className="input-field text-center font-bold" placeholder="å·¥æ•¸" />
                                 <span className="absolute right-3 top-3 text-xs text-gray-400 pointer-events-none">å·¥</span>
                             </div>
                             <input type="number" inputMode="decimal" value={vals.amount} onChange={e => setVals({...vals, amount: e.target.value})} className="input-field flex-[1.5] font-bold" placeholder="$" />
                         </div>
                         <button onClick={handleSubmit} className="w-full py-3 rounded-lg text-white font-bold text-sm bg-morandi-main">ç™¼æ”¾è–ªè³‡</button>
                     </div>
                 </div>
             );
        };

        const ListItem = ({ item, onDelete, type }) => {
            const day = item.date.split('-')[2];
            let colorClass = 'bg-morandi-main';
            let amountClass = 'text-gray-800';
            let prefix = '';
            let label = item.name || item.note;

            if (type === 'income') { colorClass = 'bg-ios-green'; amountClass = 'text-ios-green'; prefix = '+'; }
            else if (type === 'expense') { colorClass = 'bg-morandi-pink'; amountClass = 'text-gray-800'; prefix = '-'; }
            else if (type === 'work_log') { colorClass = 'bg-ios-purple'; amountClass = 'text-ios-purple'; prefix = '+'; label = `åšå·¥: ${label || ''}` }
            else if (type === 'work_withdraw') { colorClass = 'bg-ios-green'; amountClass = 'text-green-600'; prefix = 'é ˜'; label = `å·²é ˜: ${label || ''}` }
            else if (type === 'dad') { colorClass = 'bg-ios-blue'; amountClass = 'text-ios-blue'; prefix = '+'; }
            else if (type === 'pay_worker') { colorClass = 'bg-gray-500'; amountClass = 'text-gray-800'; prefix = '-'; }
            else if (type === 'project_expense') { colorClass = 'bg-ios-orange'; amountClass = 'text-gray-800'; prefix = '-'; label = `é›œæ”¯: ${label || ''}` }

            return (
                <div className="flex justify-between items-center py-3 border-b border-gray-100 last:border-0 animate-fade-in">
                    <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white font-bold text-sm shadow-sm flex-shrink-0 ${colorClass}`}>
                            {day}
                        </div>
                        <div>
                            <div className="font-bold text-gray-800 text-base leading-tight">{label}</div>
                            {item.days && <div className="text-xs text-gray-400 mt-0.5 font-bold">{item.days} å·¥</div>}
                        </div>
                    </div>
                    <div className="flex items-center gap-3">
                        <span className={`font-bold text-base ${amountClass}`}>
                            {prefix}{fmt(item.amount)}
                        </span>
                        <button onClick={() => onDelete(item.id)} className="w-8 h-8 flex items-center justify-center bg-gray-50 rounded-full text-gray-300 hover:text-red-500 transition-colors">
                            <i className="fa-solid fa-trash-can text-xs"></i>
                        </button>
                    </div>
                </div>
            );
        };

        const ProgressBar = ({ current, target }) => {
            const pct = target > 0 ? Math.min((current / target) * 100, 100) : 0;
            const isDone = current >= target && target > 0;
            return (
                <div className="bg-white rounded-xl p-4 shadow-sm mt-4">
                    <div className="flex justify-between items-end mb-2">
                        <span className="text-xs font-bold text-gray-400 uppercase tracking-wide">
                            {isDone ? 'ç›®æ¨™é”æˆ ğŸ‰' : 'æœ¬æœˆç›®æ¨™é€²åº¦'}
                        </span>
                        <span className={`text-xs font-bold ${isDone ? 'text-morandi-gold' : 'text-morandi-main'}`}>
                            {Math.round(pct)}%
                        </span>
                    </div>
                    <div className="h-3 w-full bg-gray-100 rounded-full overflow-hidden">
                        <div className={`h-full transition-all duration-1000 ease-out progress-fill ${isDone ? 'bg-morandi-gold' : 'bg-morandi-main'}`} style={{ width: `${pct}%` }}></div>
                    </div>
                    <div className="flex justify-between mt-1 text-[10px] text-gray-400">
                        <span>$0</span>
                        <span>${fmt(target)}</span>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('personal'); 
            const [currentDate, setCurrentDate] = useState(new Date());
            const [target, setTarget] = useLocalStorage('ji_target_v9', 100000); 
            const [transactions, setTransactions] = useLocalStorage('ji_transactions_v9', []);
            const [expenseCategories, setExpenseCategories] = useLocalStorage('ji_categories_v12', INITIAL_CATEGORIES);
            
            // å…¨åŸŸåˆªé™¤ç¢ºèª State
            const [deleteModalOpen, setDeleteModalOpen] = useState(false);
            const [transactionToDelete, setTransactionToDelete] = useState(null);

            const yearMonth = useMemo(() => {
                const y = currentDate.getFullYear();
                const m = String(currentDate.getMonth() + 1).padStart(2, '0');
                return `${y}-${m}`;
            }, [currentDate]);
            const displayMonth = `${currentDate.getFullYear()}å¹´ ${currentDate.getMonth() + 1}æœˆ`;
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

            const monthlyData = useMemo(() => {
                return transactions
                    .filter(t => t.date.startsWith(yearMonth))
                    .sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            }, [transactions, yearMonth]);

            const incomeList = monthlyData.filter(t => t.type === 'income');
            const expenseList = monthlyData.filter(t => t.type === 'expense');
            const workLogList = monthlyData.filter(t => t.type === 'work_log');
            const workWithdrawList = monthlyData.filter(t => t.type === 'work_withdraw');
            
            // Project
            const dadList = monthlyData.filter(t => t.type === 'dad');
            const payWorkerList = monthlyData.filter(t => t.type === 'pay_worker');
            const projectExpenseList = monthlyData.filter(t => t.type === 'project_expense');

            // Personal Stats
            const totalIncome = incomeList.reduce((sum, t) => sum + Number(t.amount), 0);
            const totalExpense = expenseList.reduce((sum, t) => sum + Number(t.amount), 0);
            const monthlySavings = totalIncome - totalExpense;

            // Work Hours Stats
            const totalWorkDays = workLogList.reduce((sum, t) => sum + Number(t.days || 0), 0);
            const totalWorkEarnings = workLogList.reduce((sum, t) => sum + Number(t.amount), 0);
            const totalWithdrawAmount = workWithdrawList.reduce((sum, t) => sum + Number(t.amount), 0);
            const unpaidAmount = totalWorkEarnings - totalWithdrawAmount;

            // Project Stats
            const totalDad = dadList.reduce((sum, t) => sum + Number(t.amount), 0);
            const totalPay = payWorkerList.reduce((sum, t) => sum + Number(t.amount), 0);
            const totalProjExp = projectExpenseList.reduce((sum, t) => sum + Number(t.amount), 0);
            const projectBalance = totalDad - totalPay - totalProjExp;

            const addTrans = (type, data) => {
                const newT = { id: Date.now(), type, ...data, amount: Number(data.amount) };
                if (!newT.date.startsWith(yearMonth)) alert(`ç´€éŒ„å·²æ–°å¢è‡³ ${newT.date}ï¼Œè«‹åˆ‡æ›æœˆä»½æŸ¥çœ‹`);
                setTransactions(prev => [newT, ...prev]);
            };

            // Trigger Delete Modal
            const requestDelete = (id) => {
                setTransactionToDelete(id);
                setDeleteModalOpen(true);
            };

            // Actual Delete
            const confirmDeleteTransaction = () => {
                if(transactionToDelete) {
                    setTransactions(prev => prev.filter(t => t.id !== transactionToDelete));
                    setDeleteModalOpen(false);
                    setTransactionToDelete(null);
                }
            };

            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            useEffect(() => {
                if (activeTab === 'personal' && canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['æ”¶å…¥', 'æ”¯å‡º', 'çµé¤˜'],
                            datasets: [{
                                data: [totalIncome, totalExpense, monthlySavings],
                                backgroundColor: ['#A7D7C5', '#F4ACB7', '#778DA9'],
                                borderRadius: 6, barThickness: 40
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } }
                    });
                }
            }, [activeTab, totalIncome, totalExpense, monthlySavings]);

            return (
                <div className="max-w-md mx-auto min-h-screen">
                    {/* Delete Modal */}
                    <ConfirmDeleteModal 
                        isOpen={deleteModalOpen}
                        onClose={() => setDeleteModalOpen(false)}
                        onConfirm={confirmDeleteTransaction}
                    />

                    <div className="sticky top-0 z-50 bg-[#F2F2F7]/95 backdrop-blur-md px-4 py-3 border-b border-gray-200">
                        <div className="flex justify-between items-center bg-white rounded-xl p-1 shadow-sm">
                            <button onClick={prevMonth} className="w-10 h-8 text-gray-400 hover:text-ios-blue active:scale-90 transition-transform"><i className="fa-solid fa-chevron-left"></i></button>
                            <div className="font-rounded font-bold text-lg text-morandi-accent">{displayMonth}</div>
                            <button onClick={nextMonth} className="w-10 h-8 text-gray-400 hover:text-ios-blue active:scale-90 transition-transform"><i className="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div className="px-4 mt-4">
                        <div className="segment-control">
                            <div onClick={() => setActiveTab('personal')} className={`segment-btn ${activeTab === 'personal' ? 'active-tab' : 'inactive-tab'}`}>é¤Šæˆæ—¥è¨˜</div>
                            <div onClick={() => setActiveTab('hours')} className={`segment-btn ${activeTab === 'hours' ? 'active-tab' : 'inactive-tab'}`}>å·¥æ™‚ç´€éŒ„</div>
                            <div onClick={() => setActiveTab('work')} className={`segment-btn ${activeTab === 'work' ? 'active-tab' : 'inactive-tab'}`}>å·¥åœ°è¨˜å¸³</div>
                        </div>

                        {activeTab === 'personal' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-gradient-to-br from-[#778DA9] to-[#415A77] rounded-2xl p-6 text-white shadow-ios relative overflow-hidden">
                                    <div className="flex justify-between items-start mb-2 relative z-10">
                                        <span className="text-xs font-bold opacity-80 uppercase tracking-widest">æœ¬æœˆçµé¤˜</span>
                                        <div className="flex items-center gap-2 bg-white/10 px-2 py-1 rounded-lg backdrop-blur-sm">
                                            <span className="text-xs opacity-70">ç›®æ¨™</span>
                                            <input type="number" inputMode="decimal" value={target} onChange={(e) => setTarget(e.target.value)} className="w-16 bg-transparent text-right text-xs font-bold outline-none text-white" />
                                        </div>
                                    </div>
                                    <div className={`text-4xl font-rounded font-bold mb-4 tracking-tight relative z-10 ${monthlySavings < 0 ? 'text-red-200' : ''}`}>${fmt(monthlySavings)}</div>
                                </div>
                                <ProgressBar current={monthlySavings} target={target} />
                                <SimpleInput title={`è–ªè³‡æ”¶å…¥ ($${fmt(totalIncome)})`} onAdd={(d) => addTrans('income', d)} btnColor="bg-ios-green" inputColor="text-ios-green"/>
                                {incomeList.map(t => <ListItem key={t.id} item={t} onDelete={requestDelete} type="income" />)}
                                
                                <ExpenseForm 
                                    onAdd={(d) => addTrans('expense', d)} 
                                    categories={expenseCategories}
                                    setCategories={setExpenseCategories}
                                />
                                
                                <div className="bg-white rounded-xl px-4 py-2 mb-4">
                                    <div className="text-xs text-gray-400 font-bold uppercase py-2 border-b border-gray-50 flex justify-between">
                                        <span>æ”¯å‡ºåˆ—è¡¨</span>
                                        <span>ç¸½è¨ˆ: ${fmt(totalExpense)}</span>
                                    </div>
                                    {expenseList.length === 0 && <div className="text-center text-xs text-gray-300 py-4">ç„¡æ”¯å‡º</div>}
                                    {expenseList.map(t => <ListItem key={t.id} item={t} onDelete={requestDelete} type="expense" />)}
                                </div>
                                <div className="bg-white rounded-xl p-4 shadow-sm mb-8 h-64"><canvas ref={canvasRef}></canvas></div>
                            </div>
                        )}

                        {activeTab === 'hours' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-5 text-white shadow-ios">
                                    <div className="flex justify-between items-center mb-4">
                                        <div>
                                            <p className="text-xs font-bold opacity-70 uppercase">é è¨ˆç¸½æ”¶å…¥</p>
                                            <div className="text-2xl font-bold">${fmt(totalWorkEarnings)}</div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xs font-bold opacity-70 uppercase">å¯¦éš›å·²é ˜</p>
                                            <div className="text-2xl font-bold text-green-300">${fmt(totalWithdrawAmount)}</div>
                                        </div>
                                    </div>
                                    <div className="pt-3 border-t border-white/20">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs font-bold uppercase tracking-widest opacity-80">æœªçµé¤˜é¡</span>
                                            <span className="text-xl font-bold text-yellow-300">${fmt(unpaidAmount)}</span>
                                        </div>
                                    </div>
                                </div>
                                <WorkHoursForm onAdd={(d) => addTrans('work_log', d)} />
                                <WorkWithdrawForm onAdd={(d) => addTrans('work_withdraw', d)} />
                                <div className="bg-white rounded-xl px-4 py-2 mb-8">
                                    <div className="text-xs text-gray-400 font-bold uppercase py-2 border-b border-gray-50">æœ¬æœˆå·¥æ™‚ç´€éŒ„è¡¨</div>
                                    {[...workLogList, ...workWithdrawList].sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => <ListItem key={t.id} item={t} onDelete={requestDelete} type={t.type} />)}
                                    {workLogList.length === 0 && workWithdrawList.length === 0 && <div className="text-center text-xs text-gray-300 py-4">ç„¡ç´€éŒ„</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'work' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-white rounded-2xl p-6 shadow-ios text-center border border-gray-100">
                                    <p className="text-gray-400 text-xs font-bold uppercase mb-2">å·¥åœ°å¸³æˆ¶é¤˜é¡</p>
                                    <div className={`text-4xl font-rounded font-bold mb-2 ${projectBalance < 0 ? 'text-red-500' : 'text-gray-800'}`}>${fmt(projectBalance)}</div>
                                </div>
                                
                                <SimpleInput title={`è³‡é‡‘å…¥å¸³ ($${fmt(totalDad)})`} onAdd={(d) => addTrans('dad', d)} btnColor="bg-ios-blue" inputColor="text-ios-blue"/>
                                {dadList.map(t => <ListItem key={t.id} item={t} onDelete={requestDelete} type="dad" />)}
                                
                                <ProjectPaymentForm title={`ç™¼è–ªæ°´ ($${fmt(totalPay)})`} onAdd={(d) => addTrans('pay_worker', d)} />
                                {payWorkerList.map(t => <ListItem key={t.id} item={t} onDelete={requestDelete} type="pay_worker" />)}
                                
                                <ProjectExpenseForm onAdd={(d) => addTrans('project_expense', d)} />
                                <div className="bg-white rounded-xl px-4 py-2 mb-8">
                                    <div className="text-xs text-gray-400 font-bold uppercase py-2 border-b border-gray-50 flex justify-between">
                                        <span>é›œæ”¯åˆ—è¡¨</span>
                                        <span>ç¸½è¨ˆ: ${fmt(totalProjExp)}</span>
                                    </div>
                                    {projectExpenseList.length === 0 && <div className="text-center text-xs text-gray-300 py-4">ç„¡æ”¯å‡º</div>}
                                    {projectExpenseList.map(t => <ListItem key={t.id} item={t} onDelete={requestDelete} type="project_expense" />)}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

